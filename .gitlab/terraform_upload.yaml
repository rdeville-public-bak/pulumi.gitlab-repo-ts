.terraform_module_upload_aws:
  image: curlimages/curl:latest
  variables:
    # The path to your Terraform module
    TERRAFORM_MODULE_DIR: ${CI_PROJECT_DIR}
    # The name of your Terraform module
    TERRAFORM_MODULE_NAME: ${CI_PROJECT_NAME}
    # The system or provider your Terraform module targets (ex. local, aws, google)
    TERRAFORM_MODULE_SYSTEM: ""
    # The version of your Terraform module to be published to your project's registry
    TERRAFORM_MODULE_VERSION: ${CI_COMMIT_TAG}
  script:
      # Module-name must not have spaces or underscores, so translate them to hyphens
    - TERRAFORM_MODULE_NAME=$(echo "${TERRAFORM_MODULE_NAME}" | tr " _" -)
    - if [[ -n "${TERRAFORM_MODULE_SYSTEM}" ]]
      then
        TERRAFORM_MODULE_FULLNAME=${TERRAFORM_MODULE_NAME}-${TERRAFORM_MODULE_SYSTEM}-${TERRAFORM_MODULE_VERSION}
        TERRAFORM_MODULE_FULL_SYSNAME=${TERRAFORM_MODULE_NAME}/${TERRAFORM_MODULE_SYSTEM}/${TERRAFORM_MODULE_VERSION}
      else
        TERRAFORM_MODULE_FULLNAME=${TERRAFORM_MODULE_NAME}-${TERRAFORM_MODULE_VERSION}
        TERRAFORM_MODULE_FULLNAME=${TERRAFORM_MODULE_NAME}/${TERRAFORM_MODULE_VERSION}
      fi
    - tar -vczf ${TERRAFORM_MODULE_FULLNAME}.tgz -C ${TERRAFORM_MODULE_DIR} --exclude=./.git .
    - |-
      curl \
        --fail-with-body \
        --location \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}"
        --upload-file ${TERRAFORM_MODULE_FULLNAME}.tgz \
        ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/terraform/modules/${TERRAFORM_MODULE_FULL_SYSNAME}/file'
  rules:
    - if: $CI_COMMIT_TAG
